<div [ktBusy]="isLoading">
    <kt-portlet>
      <kt-portlet-header [class]="'card-head-lg'" [sticky]="false" [title]="'Goods Dispatch Note'"
                         ></kt-portlet-header>
      <!--begin::Form-->
        <form (ngSubmit)="onSubmit()" [formGroup]="dispatchNoteForm" class="kt-form kt-form--label-align-right">
          <div class="kt-portlet__body">
            <div class="kt-form__section kt-form__section--first">
              <div class="col-md-12 col-lg-12 col-sm-12">
                <div class="row mt-8 mb-5">
                  <div class="col-md-3 col-lg-3 col-sm-3">
                    <div class="form-group kt-form__group mb-0">
                      <label class="col-form-label pt-0">Customer Name:</label>
                      <!-- <kt-simple-dropdown
                        (blurEvent)="logValidationErrors(this.dispatchNoteForm, this.formErrors, this.validationMessages)"
                        [errorMessage]="formErrors.customerName"
                        [isDisabled]="true"
                        [optionList]="businessPartnerService.getBusinessPartners()"
                        formControlName="customerName"
                        placeholder="Enter Customer Name"
                        propertyName="name"
                        propertyValue="id"
                        matFormFieldClass="full-width"
                        searchPlaceholder="Search Customers...">
                      </kt-simple-dropdown> -->
                    </div>
                  </div>
                  <div class="col-md-3 col-lg-3 col-sm-3">
                    <div class="form-group kt-form__group mb-0">
                      <label class="col-form-label pt-0">Contact:</label>
                      <kt-input-field
                        (blurEvent)="logValidationErrors(this.dispatchNoteForm, formErrors, validationMessages)"
                        formControlName="contact"
                        matFormFieldClass="full-width"
                        placeholder="Enter Contact">
                      </kt-input-field>
                    </div>
                  </div>
                  <div class="col-md-3 col-lg-3 col-sm-3">
                    <div class="form-group kt-form__group mb-0">
                      <label class="col-form-label pt-0">GDN Date:</label>
                      <kt-date-input
                        matFormFieldClass="full-width"
                        (blurEvent)="logValidationErrors(this.dispatchNoteForm, formErrors, validationMessages)"
                        [errorMessage]="formErrors.gdnDate"
                        formControlName="gdnDate"
                        placeholder="GDN Date">
                      </kt-date-input>
                    </div>
                  </div>
                </div>  
  
                <div class="row mt-5">
                  <div class="col-lg-12 col-md-12 col-sm-12">
                    <div class="">
                      <ng-container formArrayName="dispatchNoteLines">
                        <mat-table #table [dataSource]="dispatchNoteForm.get('dispatchNoteLines')['controls']">
                            <!-- Account Column -->
                            <ng-container matColumnDef="itemId">
                              <mat-header-cell *matHeaderCellDef class="flex-1"> Item</mat-header-cell>
                              <mat-cell *matCellDef="let element;  let i = index" [formGroup]="element" class="flex-1">
                                <div class="col-lg-12 col-sm-12">
                                  <kt-simple-dropdown
                                    (selectionChange)="onItemSelected($event.value, i)"
                                    [errorMessage]="'Item is required.'"
                                    [isDisabled]="true"
                                    matFormFieldClass="full-width input_d_1"
                                    [optionList]="productService.getProducts()"
                                    formControlName="itemId"
                                    placeholder="Select Item"
                                    propertyName="productName"
                                    propertyValue="id">
                                  </kt-simple-dropdown>
                                </div>
                              </mat-cell>
                            </ng-container>
                            <!--Partner Column-->
                            <ng-container matColumnDef="description">
                              <mat-header-cell *matHeaderCellDef class="flex-1"> Description</mat-header-cell>
                              <mat-cell *matCellDef="let element;  let i = index" [formGroup]="element" class="flex-1">
                                <div class="col-lg-12 col-sm-12">
                                  <kt-input-field
                                    (blurEvent)="logValidationErrors(this.dispatchNoteForm, formErrors, validationMessages)"
                                    [errorMessage]="[{ condition : dispatchNoteForm.get('dispatchNoteLines')['controls'][i].controls.description.errors?.required &&
                                                                dispatchNoteForm.get('dispatchNoteLines')['controls'][i].controls.description.touched ,
                                                    error : 'Description is required' }]"
                                    formControlName="description"
                                    matFormFieldClass="full-width input_d_1"
                                    placeholder="Enter Description">
                                  </kt-input-field>
                                </div>
                              </mat-cell>
                            </ng-container>
                            <!-- Description Column -->
                            <ng-container matColumnDef="quantity">
                              <mat-header-cell *matHeaderCellDef class="flex-1"> Quantity</mat-header-cell>
                              <mat-cell *matCellDef="let element;  let i = index" [formGroup]="element" class="flex-1">
                                <div class="col-lg-12 col-sm-12">
                                  <kt-input-field
                                    #itemName
                                    [type]="'number'"
                                    matFormFieldClass="full-width input_d_1"
                                    (blurEvent)="logValidationErrors(this.dispatchNoteForm, formErrors, validationMessages)"
                                    (change)="onChangeEvent($event , i , itemName)"
                                    (keyup)="onChangeEvent($event , i , itemName)"
                                    [errorMessage]="[{ condition : dispatchNoteForm.get('dispatchNoteLines')['controls'][i].controls.quantity.errors?.required &&
                                                                  dispatchNoteForm.get('dispatchNoteLines')['controls'][i].controls.quantity.touched ,
                                                      error : 'Quantity is required' },
                                                    { condition : dispatchNoteForm.get('dispatchNoteLines')['controls'][i].controls.quantity.errors?.min &&
                                                                dispatchNoteForm.get('dispatchNoteLines')['controls'][i].controls.quantity.touched ,
                                                      error : 'Minimum value is one' },
                                                    { condition : dispatchNoteForm.get('dispatchNoteLines')['controls'][i].controls.quantity.errors?.max &&
                                                                  dispatchNoteForm.get('dispatchNoteLines')['controls'][i].controls.quantity.touched ,
                                                      error : 'Value cannot exceed the billed quantity' }]"
                                    formControlName="quantity"
                                    placeholder="Enter Quantity">
                                  </kt-input-field>
                                </div>
                              </mat-cell>
                            </ng-container>
                            <!-- Credit Column -->
                            <!-- Location Column -->
                            <ng-container matColumnDef="locationId">
                              <mat-header-cell *matHeaderCellDef class="flex-1">Location </mat-header-cell>
                              <mat-cell *matCellDef="let element;  let i = index" [formGroup]="element" class="flex-1">
                                <div class="col-lg-12 col-sm-12">
                                  <kt-group-dropdown
                                    [isDisabled]="true"
                                    [errorMessage]="'Location is required.'"
                                    [optionList]="warehouseService.getWarehouses()"
                                    formControlName="locationId"
                                    groupChildrenName="locations"
                                    groupPropertyName="name"
                                    placeholder="Select Location"
                                    propertyName="name"
                                    matFormFieldClass="full-width input_d_1"
                                    propertyValue="id">
                                  </kt-group-dropdown>
                                </div>
                              </mat-cell>
                            </ng-container>
    
                            <!-- Action Column -->
                            <ng-container matColumnDef="action">
                              <mat-header-cell *matHeaderCellDef class="flex-1">Action</mat-header-cell>
                              <mat-cell *matCellDef="let element;  let i = index" [formGroup]="element" class="flex-1">
                                <!-- <mat-icon class="delete-button" (click)="removeJournalEntryLineClick(i);">delete_forever
                                      </mat-icon> -->
    
                                <button class=" app-remove-btn" type="button"
                                (click)="removeDispatchNoteLineClick(i)">
                                  <i class="fas fa-trash" aria-hidden="true"></i>
                                </button>
                              </mat-cell>
                            </ng-container>
                            <mat-header-row *matHeaderRowDef="displayedColumns"></mat-header-row>
                            <mat-row *matRowDef="let row; columns: displayedColumns;"></mat-row>
                          </mat-table>
                      </ng-container>
    
                      <ng-container>
                        <div class="row">
                          <div class="col-md-12 col-sm-12">
                            <button class=" app-add-new-line-btn" type="button" (click)="addDispatchNoteLineClick()">
                              <i class="fas fa-plus" aria-hidden="true"> </i> Add New Line
                            </button>
                          </div>
                        </div>
                      </ng-container>
    
                    </div>
                  </div>
                </div>
              </div>
              
              <!--Goods Dispatch Note Lines-->
              
            </div>
          </div>
          
          <mat-divider class="mt-10"></mat-divider>
  
          <div class="kt-portlet__foot p-5">
            <div class="kt-form__actions kt-form__actions mb-0">
              <div class="row text-right">
                <div class="col-lg-12">
                  <button (click)="reset()"  class="mr-2 app-reset-btn" type="reset">
                   <i class="fas fa-undo"></i> Reset
                  </button>
                  <button
                    (click)="logValidationErrors(this.dispatchNoteForm, this.formErrors, this.validationMessages); gdnModel.isSubmit = 0"
                    class=" mr-2 app-save-btn"
                    type="submit">
                    <i class="far fa-save"></i> Save
                  </button>
                  <button
                    (click)="logValidationErrors(this.dispatchNoteForm, this.formErrors, this.validationMessages);gdnModel.isSubmit = 1"
                    class="app-default-btn" 
                    type="submit">
                    <i class="far fa-save"></i> Submit
                  </button>
                </div>
              </div>
            </div>
          </div>
        </form>
      <!--end::Form-->
    </kt-portlet>
  
  </div>
  
  
  